@model ClientPortal.Web.Models.IndexModel

@{
    var now = DateTime.Now;
    var sunday = now;
    while (sunday.DayOfWeek != DayOfWeek.Sunday) { sunday = sunday.AddDays(-1); }
    var firstOfMonthDT = new DateTime(now.Year, now.Month, 1);

    var today = now.ToString("d", Model.CultureInfo);
    var yesterday = now.AddDays(-1).ToString("d", Model.CultureInfo);
    var firstOfMonth = firstOfMonthDT.ToString("d", Model.CultureInfo);
    var firstOfYear = new DateTime(now.Year, 1, 1).ToString("d", Model.CultureInfo);
    var firstOfLastMonth = firstOfMonthDT.AddMonths(-1).ToString("d", Model.CultureInfo);
    var lastOfLastMonth = firstOfMonthDT.AddDays(-1).ToString("d", Model.CultureInfo);
    var firstOfWeek = sunday.ToString("d", Model.CultureInfo);
    var firstOfLastWeek = sunday.AddDays(-7).ToString("d", Model.CultureInfo);
    var lastOfLastWeek = sunday.AddDays(-1).ToString("d", Model.CultureInfo);

    var todayMY = now.ToString("MM/yyyy");
    var lastMonthMY = firstOfMonthDT.AddMonths(-1).ToString("MM/yyyy");
    var threeMonthsAgoMY = firstOfMonthDT.AddMonths(-3).ToString("MM/yyyy");
    var firstOfYearMY = new DateTime(now.Year, 1, 1).ToString("MM/yyyy");
}

@*<!--+---------+
      | Top Bar |
      +---------+-->*@
<div class="row">
    <div class="six columns toplogo">
        <img src="~/Images/logo1.png" />
    </div>
    <div class="three columns topinfo">
        @Html.Partial("_HelloPartial")
    </div>
    <div class="three columns logout">
        <div style="float: right">
            @Html.Partial("_LoginPartial")
        </div>
    </div>
</div>
<!-- /TopBar -->

@*<!--+--------------------------------------+
      | Gray Band/HTabs Background/Container | 
      +--------------------------------------+-->*@
<div class="row">
    <div class="twelve columns grayband">
    </div>
</div>
<!-- /GrayBandForHTabs -->

@*<!--+--------------+
      | Main Content |
      +--------------+-->*@
<div class="row" id="main">

    @*<!--+---------+
          | Sidebar |
          +---------+-->*@
    <div class="two columns portaltabs-v">

        @*<!--+---------------+
              | Vertical Tabs |
              +---------------+-->*@
        <dl class="vertical tabs">
            <dd class="active"><a href="#vertical1" id="vertNav_Dashboard">Dashboard</a></dd>
            <dd><a href="#vertical2" id="vertNav_Reports">Reports</a></dd>
            <dd><a href="#vertical3" data-bind="click: loadMyAccount">My Account</a></dd>
            <dd><a href="#vertical4" id="vertNav_Notifications">Notifications</a></dd>
        </dl>
        <!-- /VTabs -->

        @*<!--+----------+
              | Contacts |
              +----------+-->*@
        <div>
            <h5>Account Manager</h5>
            <div style="float: left; width: 65px; padding: 5px; padding-top: 0px; padding-left: 10px;">
                <img style="border: 2px solid #000;" width="65" src="~/Images/avatar.png">
            </div>
            @(Model.Advertiser != null ? Model.Advertiser.AccountManagerName : "")
            <br />
            <a href="mailto:jennifer@directagents.com">jennifer@directagents.com</a>
        </div>
        <!-- /Contacts -->

    </div>
    <!-- /Sidebar -->

    @*<!--+---------------+
          | VTabs Content |
          +---------------+-->*@
    <ul class="tabs-content">

        @*<!--+-----------
              | Dashboard VTab
              +------------->*@
        <li id="vertical1Tab" class="active">
            <div class="ten columns" id="dashboardTab">
            </div>
        </li>
        <!-- /DashboardVTabContent   -->

        @*<!--+----------
              | Reports VTab
              +------------>*@
        <li id="vertical2Tab">
            <div class="ten columns portaltabs-h">

                @*<!--+----------------+
                      | Reports HTabs  |
                      +----------------+-->*@
                <dl class="tabs">
                    <dd class="active"><a href="#repOffSum" id="repNav_OffSum">Offer Summary</a></dd>
                    <dd><a href="#repDaySum" id="repNav_DaySum">Daily Summary</a></dd>
                    <dd><a href="#repConversions" id="repNav_Conversions">Conversion Report</a></dd>
                    <dd><a href="#repCPM" id="repNav_CPM">CPM</a></dd>
                    <dd><a href="#repAff" id="repNav_Aff">Affiliates</a></dd>
                </dl>
                <!-- /ReportsHTabs  -->

                @*<!--+------------------------+
                      | Reports HTabs Content  |
                      +------------------------+-->*@
                <ul class="tabs-content">
                    <li id="repOffSumTab" class="active">
                        <div id="offsumNotLoaded"></div>
                    </li>
                    <li id="repDaySumTab"></li>
                    <li id="repConversionsTab"></li>
                    <li id="repCPMTab"></li>
                    <li id="repAffTab"></li>
                </ul>
                <!-- /ReportsContent  -->

            </div>
        </li>
        <!-- /Reports   -->

        @*<!--+------------
              | My Account VTab
              +-------------->*@
        <li id="vertical3Tab">

            @*<!--+-----------------+
                  | My Account Tabs |
                  +-----------------+-->*@
            <div class="ten columns portaltabs-h">
                <dl class="tabs">
                    <dd class="active"><a href="#goals" id="navGoals">Goals</a></dd>
                    <dd><a href="#files" id="navFiles">Files</a></dd>
                    <dd><a href="#invoices" id="navInvoices">Invoices</a></dd>
                    <dd><a href="#contact" id="navContact">Contact</a></dd>
                </dl>
                <!-- /MyAccountTabs  -->


                @*<!--+-------------------------+
                      | My Account Tabs Content |
                      +-------------------------+-->*@
                <ul class="tabs-content">
                    <li id="goalsTab" class="active">
                        <div id="divGoals"></div>
                    </li>
                    <li id="filesTab">
                        <div id="divFiles"></div>
                    </li>
                    <li id="invoicesTab">
                        <div id="divInvoices"></div>
                    </li>
                    <li id="contactTab">
                        <div id="divContact"></div>
                    </li>
                </ul>
                <!-- /MyAccountContent  -->

            </div>
        </li>
        <!-- /MyAccount   -->

        @*<!--+--------------
              | Notifications VTab
              +-------------- -->*@
        <li id="vertical4Tab">
            <h3>Notifications</h3>
        </li>
        <!-- /Notifications  -->

    </ul>
    <!-- /VTabs -->

</div>
<!-- /MainContent -->

@*<!--+---------------------+
      | Footer / Bottom Bar |
      +---------------------+-->*@
<footer class="row">
    <div class="twelve columns">
        <div class="row">
            <div class="six columns">
                <p>&copy; 2013 Direct Agents</p>
            </div>
            <div class="six columns">
            </div>
        </div>
    </div>
</footer>
<!-- /BottomBar  -->

@Html.Partial("~/Views/Goals/_Infrastructure.cshtml")

@section head {
    <link href="~/Content/kendo/2012.3.1114/kendo.common.min.css" rel="stylesheet" />
    <link href="~/Content/kendo/2012.3.1114/kendo.bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/index.css" rel="stylesheet" />
}

@section scripts {
    <script src="~/Scripts/kendo/2012.3.1114/kendo.all.min.js"></script>
    <script src="~/Scripts/kendo/2012.3.1114/cultures/kendo.culture.de-DE.min.js"></script>
    <script src="~/Scripts/kendo/2012.3.1114/cultures/kendo.culture.en-GB.min.js"></script>
    <script src="~/Scripts/kendo/2012.3.1114/cultures/kendo.culture.en-AU.min.js"></script>
    <script>

        // ready function
        $(function () {
            LoadDashboard();
            SetupTabs();
            SetupGoalWindow();
            $(window).bind('resize', WindowResize);
        });

        function jumpToOffSumRep(timeFrame) {
            $('#vertNav_Reports').trigger('click');
            $('#repNav_OffSum').trigger('click');
        }

        function WindowResize() {
            ResizeDashboardCharts();
            ResizeChart('offsum', true);
            ResizeChart('daysum', true);
            ResizeChart('conrep', true);
        }

        // Resize a chart, optionally refreshing it.
        function ResizeChart(chart, refresh) {
            var offset = 0;
            if (chart == 'daysum') offset = 225;

            if ($('#' + chart + 'ChartSection').length > 0) {
                var w = $('#' + chart + 'ChartSection').width();
                if (w > 0) {
                    $('#' + chart + 'ChartSection .chart-wrapper').css('width', w - offset);
                    if (refresh)
                        $('#' + chart + 'Chart').data('kendoChart').refresh();
                }
            }
        }

        function LoadDashboard() {
            $.ajax({
                url: '@Url.Action("Dashboard")',
                cache: false
            }).done(function (html) {
                $("#dashboardTab").html(html);
                drawHeatMap();
            });
        }

        function OffSumClick() {
            if ($('#offsumChart').length == 0) {
                $.ajax({
                    url: '@Url.Action("OfferSummaryPartial", "Reports")',
                    cache: false
                }).done(function (html) {
                    $("#repOffSumTab").html(html);
                    ResizeChart('offsum', false);
                    SetupOfferSummaryGrid();
                });
            } else {
                setTimeout(function () { ResizeChart('offsum', true); }, 100);
            }
        }

        // Setup kendo view model with click behaviors for tabs..
        var viewModel = kendo.observable({
            loadMyAccount: function () {
                $.ajax({
                    url: '@Url.Action("Index", "Goals")',
                    cache: false
                }).done(function (html) {
                    $("#divGoals").html(html);
                });
            }
        });
        kendo.bind($("#main"), viewModel);

        // Setup event handlers so that AJAX content loads on demand as tabs are clicked.
        function SetupTabs() {

            // Dashboard
            $("#vertNav_Dashboard").click(function () {
                LoadDashboard();
            });

            // Files
            $("#navFiles").one("click", function () {
                $.ajax({
                    url: '@Url.Action("Index", "Files")',
                    cache: false
                }).done(function (html) {
                    $("#divFiles").html(html);
                });
            });

            // Invoices
            $("#navInvoices").click(function () {
                $.ajax({
                    url: '@Url.Action("Index", "Invoices")',
                    cache: false
                }).done(function (html) {
                    $("#divInvoices").html(html);
                });
            });

            // Contacts
            $("#navContact").one("click", function () {
                $("#divContact").html('Loading...');
                $.ajax({
                    url: '@Url.Action("Contact", "Home")',
                    cache: false
                }).done(function (html) {
                    $("#divContact").html(html);
                });
            });

            // Offer Summary
            $("#repNav_OffSum").click(function () {
                if ($('#offsumChart').length == 0) {
                    $.ajax({
                        url: '@Url.Action("OfferSummaryPartial", "Reports")',
                        cache: false
                    }).done(function (html) {
                        $("#repOffSumTab").html(html);
                        ResizeChart('offsum', false);
                        SetupOfferSummaryGrid();
                    });
                } else {
                    setTimeout(function () { ResizeChart('offsum', true); }, 100);
                }
            });

            // Daily Summary
            $("#repNav_DaySum").click(function () {
                if ($('#daysumChart').length == 0) {
                    $.ajax({
                        url: '@Url.Action("DailySummaryPartial", "Reports")',
                        cache: false
                    }).done(function (html) {
                        $("#repDaySumTab").html(html);
                        ResizeChart('daysum', false);
                        SetupDailySummaryGrid();
                    });
                } else {
                    setTimeout(function () { ResizeChart('daysum', true); }, 100);
                }
            });

            // Conversions
            $("#repNav_Conversions").click(function () {
                if ($('#conrepChart').length == 0) {
                    $.ajax({
                        url: '@Url.Action("ConversionReportPartial", "Reports")',
                        cache: false
                    }).done(function (html) {
                        $("#repConversionsTab").html(html);
                        ResizeChart('conrep', false);
                        SetupConversionReportGrid();
                        SetupConversionReportChart();
                    });
                } else {
                    setTimeout(function () { ResizeChart('conrep', true); }, 100);
                }
            });

            // Reports
            $("#vertNav_Reports").click(function () {
                if ($('#offsumNotLoaded').length > 0)
                    OffSumClick();
            });

            // Offer Summary
            $("#repNav_OffSum").click(function () {
                OffSumClick();
            });

            // CPM
            $("#repNav_CPM").one("click", function () {
                $.ajax({
                    url: '@Url.Action("CPMSummaryPartial", "Reports")',
                    cache: false
                }).done(function (html) {
                    $("#repCPMTab").html(html);
                    SetupCPMSummaryGrid();
                });
            });

            // Affilaites
            $("#repNav_Aff").click(function () {
                $.ajax({
                    url: '@Url.Action("AffiliateReportPartial", "Reports")',
                    cache: false
                }).done(function (html) {
                    $("#repAffTab").html(html);
                    SetupAffiliateReportGrid();
                });
            });

            // Contacts
            $("#navContact").one("click", function () {
                $("#divContact").html('Loading...');
                $.ajax({
                    url: '@Url.Action("Contact", "Home")',
                        cache: false
                    }).done(function (html) {
                        $("#divContact").html(html);
                    });
            });
        }

        //
        function DateChanged(grid) {
            $('#' + grid + '_dateRangeSel').data('kendoDropDownList').value('custom');
            $('#' + grid + '_filterBtn').attr('disabled', false);
        }

        //
        function ChangeDateRange(grid) {
            var startId = '#' + grid + '_startdate';
            var endId = '#' + grid + '_enddate';
            var refresh = true;
            var dateRange = $('#' + grid + '_dateRangeSel').val();
            switch (dateRange) {
                case "today":
                    $(startId).val('@today');
                    $(endId).val('@today');
                    break;
                case "yesterday":
                    $(startId).val('@yesterday');
                    $(endId).val('@yesterday');
                    break;
                case "wtd":
                    $(startId).val('@firstOfWeek');
                    $(endId).val('@today');
                    break;
                case "mtd":
                    $(startId).val('@firstOfMonth');
                    $(endId).val('@today');
                    break;
                case "ytd":
                    $(startId).val('@firstOfYear');
                    $(endId).val('@today');
                    break;
                case "lastweek":
                    $(startId).val('@firstOfLastWeek');
                    $(endId).val('@lastOfLastWeek');
                    break;
                case "lastmonth":
                    $(startId).val('@firstOfLastMonth');
                    $(endId).val('@lastOfLastMonth');
                    break;
                default:
                    refresh = false;
            }
            if (refresh)
                RefreshGrid(grid);
        }

        //
        function ChangeDateRangeMY(grid) {
            var startId = '#' + grid + '_startdate';
            var endId = '#' + grid + '_enddate';
            var refresh = true;
            var dateRange = $('#' + grid + '_dateRangeSel').val();
            switch (dateRange) {
                case "prev3months":
                    $(startId).val('@threeMonthsAgoMY');
                    $(endId).val('@lastMonthMY');
                    break;
                case "lastmonth":
                    $(startId).val('@lastMonthMY');
                    $(endId).val('@lastMonthMY');
                    break;
                case "ytd":
                    $(startId).val('@firstOfYearMY');
                    $(endId).val('@todayMY');
                    break;
                default:
                    refresh = false;
            }
            if (refresh)
                RefreshGrid(grid);
        }

        //
        function RefreshGrid(grid) {
            var gridDataSource = $('#' + grid + 'Grid').data('kendoGrid').dataSource;
            gridDataSource.read();
            if ($('#' + grid + 'Chart').length > 0) {
                var chartDataSource = $('#' + grid + 'Chart').data('kendoChart').dataSource;
                if (chartDataSource !== gridDataSource)
                    chartDataSource.read();
            }
            $('#' + grid + '_filterBtn').attr('disabled', true);
        }

        // Returns val as a culture formatted string.
        function FormatCurr(val, culture) {
            kendo.culture(culture);
            return kendo.toString(val, "c");
        }

        // DataSource used by both the Offer Summary and Conversion Report tabs
        function CreateConversionReportDataSource(readData) {
            return new kendo.data.DataSource({
                serverPaging: true,
                serverSorting: true,
                serverFiltering: true,
                serverAggregates: true,
                pageSize: 50,
                transport: {
                    read: {
                        type: 'post',
                        dataType: 'json',
                        url: '@Url.Action("ConversionReportData", "Reports")',
                        data: readData
                    }
                },
                schema: {
                    data: 'data',
                    total: 'total',
                    aggregates: 'aggregates',
                    model: {
                        id: 'ConversionId',
                        fields: {
                            Date: { type: 'date' },
                            AffId: { type: 'number' },
                            OfferId: { type: 'number' },
                            Offer: { type: 'string' },
                            PriceReceived: { type: 'number' },
                            TransactionId: { type: 'string' },
                            Positive: { type: 'boolean' }
                        }
                    }
                },
                sort: [
                    { field: "Offer", dir: "asc" },
                    { field: "Date", dir: "asc" }
                ],
                aggregate: [
                    { field: "PriceReceived", aggregate: "sum" }
                ]
            });
        }
    </script>
}