@model ClientPortal.Web.Models.DashboardModel
@{
    var now = DateTime.Now;
    var firstOfMonthDT = new DateTime(now.Year, now.Month, 1);

    var today = now.ToString("d", Model.CultureInfo);
    var firstOfMonth = firstOfMonthDT.ToString("d", Model.CultureInfo);
    var firstOfYear = new DateTime(now.Year, 1, 1).ToString("d", Model.CultureInfo);
            //var firstOfLastMonth = firstOfMonthDT.AddMonths(-1).ToString("d", Model.CultureInfo);
            //var lastOfLastMonth = firstOfMonthDT.AddDays(-1).ToString("d", Model.CultureInfo);
}

<!-- Timeframe -->
<div class="row">
    <div class="twelve columns" style="top: -35px; height: 15px">
        <span>Timeframe:</span>
        <select style="width: 125px" id="dash_dateRangeSel" onchange="ChangeDashboardDateRange()">
            <option value="mtd">Month to Date</option>
            <option value="ytd">Year to Date</option>
            <option value="custom">- custom -</option>
        </select>
        <span class="paddedlabel">Start:</span>
        <input id="dash_startdate" name="startdate" type="text" value="@Html.FormatDate(Model.Start, Model.CultureInfo)" onchange="DashboardDateChanged()" />
        <span class="paddedlabel">End:</span>
        <input id="dash_enddate" name="enddate" type="text" value="@Html.FormatDate(Model.End, Model.CultureInfo)" onchange="DashboardDateChanged()" />
        <a class="button paddedbutton" id="dash_filterBtn" href="#" onclick="if($(this).attr('disabled') != 'disabled') RefreshDashboardRange(); return false">Refresh</a>
    </div>
</div>

<!-- Row 1 -->
<div class="row">

    <!-- Column 1 -->
    <div class="six columns">
        <div class="panel" id="panelSumRep">
            <b>Summary Report</b>
            <table class="summarytable" style="width: 100%">
                <tr>
                    <th></th>
                    <th>Clicks</th>
                    <th>Leads</th>
                    <th>Spend</th>
                    @if (Model.ShowConVal)
                    {
                        <th>@Model.ConValName</th>
                    }
                </tr>
                @foreach (var summary in Model.AdvertiserSummaries)
                {
                    <tr>
                        <td><a href="@summary.Link">@summary.Name</a></td>
                        <td>@String.Format("{0:n0}", summary.Clicks)</td>
                        <td>@String.Format("{0:n0}", summary.Conversions)</td>
                        <td>@summary.RevenueFormatted</td>
                        @if (Model.ShowConVal)
                        {
                            <td>@summary.ConValFormatted(Model.ConValIsNum ? "n0" : "c")</td>
                        }
                    </tr>
                }
            </table>
        </div>
    </div>

    <!-- Column 2 -->
    <div class="six columns panel" id="panelPerfChart">
        <div id="perfChartOuter">
            <b>Performance</b>
            @Html.Partial("PerformanceVis")
        </div>
    </div>

</div>

<!-- Row 2 -->
<div class="row">

    <!-- Column 1 -->
    <div class="six columns">
        <div class="panel" id="projChartOuter">
            <span><b>Projection</b></span>
            <span id="projNote" style="float: right"></span>
            @Html.Partial("ProjectionVis")
            <span style="float: right">*Based on average # of leads per day</span>
        </div>
    </div>

    <!-- Column 2 -->
    <div class="six columns panel">
        <div class="row">
            <div class="six columns">
                <div id="heatMapOuter">
                    <b>Conversions by State</b>
                    @Html.Partial("_HeatMap")
                </div>
            </div>
            <div class="six columns">
                <div id="topStatesOuter">
                    <b>Top <span id="topNStatesNumLabel" />States</b>
                    <div id="divTopStates"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Row 3 -->
<div class="row">

    <!-- Column 1 -->
    <div class="six columns">
        <div class="panel" id="spendChartOuter">
            <b>Budget</b>
            @Html.Partial("SpendVis")
        </div>
    </div>

    <!-- Column 2 -->

    <div class="six columns panel">
        <div class="row">
            <div class="six columns">
                <div id="clicksByDeviceOuter">
                    <b>Mobile Clicks</b>
                    @Html.Partial("_ClicksByDevice")
                </div>
            </div>
            <div class="six columns">
                <div id="clicksByDeviceChartOuter">
                    <b>Top Devices</b>
                    <div id="divClicksByDeviceChart"></div>
                </div>
            </div>
        </div>

        @*<div id="weeklySpendBarChartOuter">
            <b>Budget Spent Weekly</b>
            <a href="#" onclick="ShowSpendMonthly(); return false">Switch to Monthly</a>
            <div class="chart-wrapper">
                <div id="weeklySpendBarChart"></div>
            </div>
        </div>
        <div id="monthlySpendBarChartOuter" style="display: none">
            <b>Budget Spent Monthly</b>
            <a href="#" onclick="ShowSpendWeekly(); return false">Switch to Weekly</a>
            <div class="chart-wrapper">
                <div id="monthlySpendBarChart"></div>
            </div>
        </div>*@

    </div>
</div>

<!-- clicks by device (todo: properly position in the dash) -->
@*<div class="row">
    <div class="six columns panel">
        
    </div>
</div>*@

<!-- Goal Rows -->
<div id="dashboardGoals">
    @Html.Partial("DashboardGoals", Model.OfferGoalSummaries)
</div>

<script>
    $(function () {
        kendo.culture('@Model.Culture');
        $('#dash_dateRangeSel').kendoDropDownList({ value: '@Model.DateRangeType' });
        $('#dash_startdate').kendoDatePicker({ footer: ' ' });
        $('#dash_enddate').kendoDatePicker({ footer: ' ' });

        CreatePerformanceChart([''], [0], 'N0', '@Model.Culture', 173);
        CreateSpendChart(0, 'C0', '@Model.Culture', 'Spend', 75);

        var projDS = CreateProjectionDataSource('@Html.Raw(Url.Action("DailySummaryData", "Reports", new { cumulative = true, projection = true }))');
        CreateProjectionChart(projDS, 180);
        projDS.read();
        projDS.bind('change', function () {
            var aggs = this.aggregates();
            var projNote = kendo.toString(aggs.Conversions.max, 'n0') + ' Leads projected by ' + aggs.Date.max.toLocaleDateString() + '*';
            $('#projNote').html(projNote);
            UpdateProjectionChart();
        });

        var spendDS = CreateDailySpendDataSource('@Url.Action("DailySummaryData", "Reports")');
        CreateSpendLineChart(spendDS, 'Daily Spend', 125);
        CreateWeeklySpendBarChart('weeklySpendBarChart', spendDS, 200);
        spendDS.read();
        spendDS.bind('change', function () {
            var aggs = this.aggregates();
            if ($('#dash_dateRangeSel').val() == 'mtd')
                UpdatePerformanceChartValues(['Last Month', 'MTD', 'Projection'], [@Model.SummaryLM.Conversions, aggs.Conversions.sum, Projection(aggs.Conversions.sum)]);
            else
                UpdatePerformanceChartValues([$('#dash_startdate').val() + ' - ' + $('#dash_enddate').val()], [aggs.Conversions.sum]);
            UpdateSpendChart(aggs.Revenue.sum);
            UpdateSpendLineChart();
            UpdateWeeklySpendBarChart('weeklySpendBarChart');
        });

        var monthlySpendDS = CreateMonthlySpendDataSource('@Url.Action("MonthlySummaryData", "Reports")', '@firstOfYear', '@today');
        CreateMonthlySpendBarChart('monthlySpendBarChart', monthlySpendDS, 200);
        monthlySpendDS.read();

        CreateGoalCharts(); @* //defined in DashboardGoals *@
        ResizeDashboardPanelHeights();
    });

    function Projection(value) {
        var date = new Date();
        var numDays = date.getDate(); // # days gone by
        var daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        return daysInMonth * value / numDays;
    }

    function RefreshDashboardRange() {
        $.get('@Url.Action("SetDashboardDateRange", "Home")', { type: $('#dash_dateRangeSel').val(), startdate: $('#dash_startdate').val(), enddate: $('#dash_enddate').val() });
        $('#spendLineChart').data('kendoChart').dataSource.read();
        $('#monthlySpendBarChart').data('kendoChart').dataSource.read();
        $('#projChart').data('kendoChart').dataSource.read();
    }

    function DashboardDateChanged() {
        $('#dash_dateRangeSel').data('kendoDropDownList').value('custom');
    }
    function ChangeDashboardDateRange() {
        var startId = '#dash_startdate';
        var endId = '#dash_enddate';
        var refresh = true;
        var dateRange = $('#dash_dateRangeSel').val();
        switch (dateRange) {
            case "mtd":
                $(startId).val('@firstOfMonth');
                $(endId).val('@today');
                break;
            case "ytd":
                $(startId).val('@firstOfYear');
                $(endId).val('@today');
                break;
            default:
                refresh = false;
        }
        if (refresh) {
            RefreshDashboardRange();
        }
    }

    function ResizeDashboardCharts() {
        ResizeDashboardChart('proj', true);
        ResizeDashboardChart('perf', true);
        ResizeDashboardChart('spend', true);
        ResizeDashboardChart('weeklySpendBar', true);
        ResizeDashboardChart('monthlySpendBar', true);
        @foreach (var offersum in Model.OfferGoalSummaries)
        {
            <text>ResizeDashboardChart('goal@(offersum.Id)', true);</text>
        }
        ResizeDashboardPanelHeights();
    }

    function ResizeDashboardChart(chart, refresh) {
        if ($('#' + chart + 'ChartOuter').length > 0) {
            var w = $('#' + chart + 'ChartOuter').width();
            if (w > 0) {
                $('#' + chart + 'ChartOuter .chart-wrapper').css('width', w);
                if (refresh) {
                    $('#' + chart + 'Chart').data('kendoChart').refresh();
                    if (chart == 'spend')
                        $('#' + chart + 'LineChart').data('kendoChart').refresh();
                }
            }
        }
    }

    function ResizeDashboardPanelHeights() {
        ResizePanelHeights('panelSumRep', 'panelPerfChart');
        @foreach (var offersum in Model.OfferGoalSummaries)
        {
            <text>ResizeOfferGoalsRow('@(offersum.Id)');</text>
        }
    }

    function ResizeOfferGoalsRow(offersumId) {
        ResizePanelHeights('goal' + offersumId + 'SumPanel', 'goal' + offersumId + 'ChartOuter');
    }
    function ResizePanelHeights(panel1Id, panel2Id) {
        var panel1Height = $('#' + panel1Id).height();
        var panel2Height = $('#' + panel2Id).height();
        if (panel1Height > panel2Height) {
            $('#' + panel2Id).height(panel1Height);
        } else if (panel2Height > panel1Height) {
            $('#' + panel2Id).height('auto');
        }
    }

    function ShowSpendWeekly() {
        $('#monthlySpendBarChartOuter').hide();
        $('#weeklySpendBarChartOuter').show();
        ResizeDashboardChart('weeklySpendBar', true);
    }
    function ShowSpendMonthly() {
        //SetSpendBarChartBaseUnit('weeklySpendBarChart', 'months');
        $('#weeklySpendBarChartOuter').hide();
        $('#monthlySpendBarChartOuter').show();
        ResizeDashboardChart('monthlySpendBar', true);
    }

    function CreateMonthlyGoalChart(values, chartid, metric, valueFormat, culture, heading, subheading) {
        var categories = ['Last MTD', 'Last Month', 'MTD', 'Goal'];
        CreateGoalChart(categories, values, chartid, metric, valueFormat, culture, heading, subheading);
    }
    function CreateGoalChart(categories, values, chartid, metric, valueFormat, culture, heading, subheading) {
        $('#goal' + chartid + 'ChartHeading').html('<b>' + heading + '</b> ' + subheading);
        kendo.culture(culture);
        $('#goal' + chartid + 'Chart').kendoChart({
            chartArea: {
                height: 186
            },
            legend: {
                visible: false
            },
            seriesDefaults: {
                type: "column"
            },
            series: [{
                name: metric,
                data: values
            }],
            valueAxis: {
                labels: { format: valueFormat, step: 2 },
                title: { text: metric }
            },
            categoryAxis: {
                categories: categories
            },
            tooltip: {
                visible: true,
                format: valueFormat
            }
        });
    }
</script>
