@model ClientPortal.Web.Areas.Prog.Models.ReportVM
@{
    ViewBag.Title = "Creative Performance";
    if (Model.UserInfo.ProgAdvertiser.Name == "Seeso") { // for Demo
        var baseUrl = Url.Content("~/Images/");
        int j = 0;
        foreach (var stat in Model.Stats)
        {
            var creativeImage = "Seeso_300x600.jpg";
            if (j % 3 > 0) {
                creativeImage = (j % 3 == 1) ? "Seeso_728x90.jpg" : "Seeso_Video.jpg";
            }
            stat.Url = baseUrl + creativeImage;
            j++;
        }
    } else if (Model.UserInfo.ProgAdvertiser.Name == "Sephora") {
        var baseUrl = Url.Content("~/Images/Demo/");
        int j = 0;
        foreach (var stat in Model.Stats)
        {
            var creativeImage = "seph1.jpg";
            if (j % 4 > 0)
            {
                creativeImage = (j % 4 == 1) ? "seph2.jpg" : ((j % 4 == 2) ? "seph3.jpg" : "seph4.jpg");
            }
            stat.Url = baseUrl + creativeImage;
            j++;
        }
    }
    //bool showHoverCol = Model.AnyUrls();
    bool showHoverCol = true;
}

@Html.Partial("_ClientBar", Model.UserInfo)

<div id="page_content">
	<div id="container">
    	<div id="page_content">
            <section>
                <div class="heading"><p>Campaign to Date: @Model.StartDate.ToShortDateString() thru @Model.EndDate.ToShortDateString()</p></div>
                <div id="gridCreative"></div>
            </section>
        </div>
    </div>
</div>

@section scripts {
<script>
    $(document).ready(function () {
        var dsCreative = CreateCreativeDataSource();
        SetupCreativeGrid(dsCreative);
        dsCreative.read();
        SetupTooltips();
    });

    function CreateCreativeDataSource() {
        return new kendo.data.DataSource({
            transport: {
                read: {
                    type: 'post',
                    dataType: 'json',
                    url: '@Url.Action("Creative", "Stats")'
                }
            },
            schema: {
                model: {
                    id: 'Id',
                    fields: {
                        AdName: { type: 'string' },
                        Url: { type: 'string' }
                        // rest of fields: numbers
                    }
                }
            },
            //sort: { field: "eCPA", dir: "asc" }
        });
    }
    function SetupCreativeGrid(datasource) {
        $("#gridCreative").kendoGrid({
            dataSource: datasource,
            autoBind: false,
            scrollable: false,
            sortable: { allowUnsort: false },
            width: 1000,
            columns: [
                {
                    columns: [
                        { field: "AdName", title: "Creative", attributes: { class: "gridcol_string" } },
                        { field: "MediaSpend", title: "Spend", format: "{0:c}", attributes: { style: "text-align: center" } },
                        { field: "Impressions", format: "{0:n0}", attributes: { style: "text-align: center" } },
                        { field: "Clicks", format: "{0:n0}", attributes: { style: "text-align: center" } },
                        { field: "CTR", format: "{0:0.00%}", attributes: { style: "text-align: center" } },
                        { field: "eCPC", format: "{0:c}", attributes: { style: "text-align: center" } }
                    ]
                }, {
                    title: "Conversions",
                    headerAttributes: { style: "text-align: center" },
                    columns: [
                        { field: "PostClickConv", title: "Click", format: "{0:n0}", attributes: { style: "text-align: center" } },
                        { field: "PostViewConv", title: "View", format: "{0:n0}", attributes: { style: "text-align: center" } },
                        { field: "Conversions", title: "Total", format: "{0:n0}", attributes: { style: "text-align: center" } }
                    ]
                }, {
                    columns: [
                        { field: "eCPA", format: "{0:c}", attributes: { style: "text-align: center" }, sortable: { compare: Sort_eCPA } },
                    @if (showHoverCol) {
                        <text>{
                            field: "Url",
                            title: "Preview",
                            template: kendo.template($("#tmplCreativeIcon").html())
                        }</text>
                    }
                    ]
                }
            ]
        });
    }
    function Sort_eCPA(a, b, descending) {
        if (a.eCPA === b.eCPA) {
            return a.MediaSpend - b.MediaSpend;
        } else {
            if (a.eCPA == 0 || b.eCPA == 0)@* one or the other is 0, not both *@
                return b.eCPA - a.eCPA;
            else
                return a.eCPA - b.eCPA;
        }
    }

    function SetupTooltips() {
        $("#gridCreative").kendoTooltip({
            position: "left",
            filter: "td:last-child img.thumbnail",
            content: kendo.template($("#tmplCreativeHover").html())
        });
    }
</script>
<script id="tmplCreativeIcon" type="text/x-kendo-template">
    #if (Url != null) {#
        <img class="thumbnail" src="@Url.Content("~/Images/")creativethumb.gif" border="0" data-img="#: Url #">
    #}#
</script>
<script id="tmplCreativeHover" type="text/x-kendo-template">
    <div id="divHover">
        <img id="imgHover" src="#= target.data('img') #" />
    </div>
</script>
}
<style type="text/css">
    #divHover {
        position:relative;
        width:600px;
        height:300px;
    }
    #imgHover {
        max-width:600px;
        max-height:300px;
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
    }
</style>