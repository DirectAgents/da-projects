@model IEnumerable<ClientPortal.Data.Contexts.Offer>
@{
    var ajaxOptions = RazorHelpers.GetAjaxOptions("cpmOffersTab");
    var ajaxOpts_Sum = RazorHelpers.GetAjaxOptions("cpmSummaryTab", "navCPMSummary");
    var ajaxOpts_Creative = RazorHelpers.GetAjaxOptions("cpmCreativesTab", "navCPMCreatives");
    var accountManagers = Model.Select(o => o.Advertiser).Distinct().Where(a => a.AccountManagerId != null).Select(a => a.AccountManager).Distinct().OrderBy(am => am.FullName);
    var advertisers = Model.Select(o => o.Advertiser).Distinct(new ClientPortal.Data.Contexts.AdvertiserComparer()).OrderBy(a => a.AdvertiserName);
}

@if (!Request.IsAjaxRequest())
{
    <h3>CPM Offers</h3>
}
Show:
@Ajax.ActionLink("all offers", "Index", "Offers", ajaxOptions) |
@Ajax.ActionLink("filter by account manager", "Filter", "Offers", ajaxOptions)
<br />

@if (advertisers.Count() == 1)
{
    var adv = advertisers.First();
    <text>Advertiser: </text>@adv.AdvertiserName
    <text> </text>@Ajax.ActionLink("[refesh]", "Index", "Offers", new { advertiserid = adv.AdvertiserId }, ajaxOptions)
} else if (accountManagers.Count() == 1)
{
    var am = accountManagers.First();
    <text>Account Manager: </text>@am.FullName
    <text> </text>@Ajax.ActionLink("[refresh]", "Index", "Offers", new { am = am.CakeContactId }, ajaxOptions)
}

<table border="1">
    <tr>
        <th>AdvId</th>
        <th>Advertiser</th>
        <th>OfferId</th>
        <th>Offer (click for summary)</th>
        <th>Reports</th>
        <th>Drops</th>
        <th>Campaigns</th>
        <th>Creatives</th>
        <th>Creative Types</th>
    </tr>
@foreach (var offer in Model)
{
    var creativesText = "show (" + offer.Creatives.Count + ")";
    var linksText = "links (" + offer.Creatives.Where(c => c.CreativeTypeId == 1).Count() + ")";
    var emailsText = "emails (" + offer.Creatives.Where(c => c.CreativeTypeId == 2).Count() + ")";
    var imagesText = "images (" + offer.Creatives.Where(c => c.CreativeTypeId == 3).Count() + ")";
    <tr>
        <td>@offer.AdvertiserId</td>
        <td>@offer.Advertiser.AdvertiserName</td>
        <td>@offer.OfferId</td>
        <td>@Ajax.ActionLink(offer.OfferName, "Show", "Offers", new { id = offer.OfferId }, ajaxOpts_Sum, new { onclick = "ResetOfferTabs(" + offer.OfferId + ")" })</td>
        <td style="text-align:center">@offer.CPMReports.Count</td>
        <td style="text-align:center">@offer.AllCampaignDrops(null).Count()</td>
        <td style="text-align:center">@offer.Campaigns.Count</td>
        <td>@Ajax.ActionLink(creativesText, "Index", "Creatives", new { offerid = offer.OfferId }, ajaxOpts_Creative)</td>
        <td>
            &nbsp; @linksText
            &nbsp; | &nbsp; @emailsText
            &nbsp; | &nbsp; @imagesText
        </td>
    </tr>
}
</table>
<br />
