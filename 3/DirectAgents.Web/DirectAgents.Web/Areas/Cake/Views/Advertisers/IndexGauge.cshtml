@model IEnumerable<DirectAgents.Domain.DTO.CakeGauge>
@{
    ViewBag.Title = "Cake Advertisers";
    var today = DateTime.Today;
    var monthStart = new DateTime(today.Year, today.Month, 1);
}
<h2>@ViewBag.Title</h2>

<table>
    <tr>
        <th colspan="3"></th>
        <th colspan="4">Convs(MTD) - CampSums</th>
        <th colspan="3">EventConvs...</th>
        <th colspan="2">Sync (EventConvs)</th>
    </tr>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>#Offers</th>
        <th style="text-align:center">#</th>
        <th>Paid</th>
        <th>Earliest</th>
        <th>Latest</th>
        <th style="text-align:center">#</th>
        <th>Earliest</th>
        <th>Latest</th>
        <th>MTD</th>
        <th>today</th>
    </tr>
    @foreach (var gauge in Model)
    {
        var adv = gauge.Advertiser;
        var campsumsMTD = adv.Offers.SelectMany(o => o.Camps).SelectMany(c => c.CampSums).Where(cs => cs.Date >= monthStart);
        <tr>
            <td>@adv.AdvertiserId</td>
            <td>@adv.AdvertiserName</td>
            <td style="text-align:center">@Html.ActionLink(adv.Offers.Count().ToString(), "Index", "Offers", new { advId = adv.AdvertiserId }, null)</td>
            <td style="text-align:right">@((int)campsumsMTD.Sum(x => x.Conversions))</td>
            <td style="text-align:right">@((int)campsumsMTD.Sum(x => x.Paid))</td>
            <td>@Html.DisplayFor(x => gauge.CampSums.Earliest)</td>
            <td>@Html.DisplayFor(x => gauge.CampSums.Latest)</td>
            <td style="text-align:right">@adv.Offers.SelectMany(o => o.EventConversions).Count()</td>
            <td>@Html.DisplayFor(x => gauge.EventConvs.Earliest)</td>
            <td>@Html.DisplayFor(x => gauge.EventConvs.Latest)</td>
            <td>
                <div id="divCmds1_@(adv.AdvertiserId)" class="divCmds divCmds1">
                    @Html.ActionLink("clear", "ClearConvs", new { id = adv.AdvertiserId }, new { onclick = "DoClear(" + adv.AdvertiserId + ", 1)" }) |
                    @Html.ActionLink("load", "LoadConvs", new { id = adv.AdvertiserId }, new { onclick="DoLoad(" + adv.AdvertiserId + ", 1)" })
                </div>
            </td>
            <td>
                <div id="divCmds2_@(adv.AdvertiserId)" class="divCmds divCmds2">
                    @Html.ActionLink("clear", "ClearConvs", new { id = adv.AdvertiserId, justToday = true }, new { onclick = "DoClear(" + adv.AdvertiserId + ", 2)" }) |
                    @Html.ActionLink("load", "LoadConvs", new { id = adv.AdvertiserId, justToday = true }, new { onclick = "DoLoad(" + adv.AdvertiserId + ", 2)" })
                </div>
            </td>
        </tr>
    }
</table>

<script>
    function DoClear(id, cmdCol) {
        DoCmd(id, cmdCol, "Clearing....");
    }
    function DoLoad(id, cmdCol) {
        DoCmd(id, cmdCol, "Loading....");
    }
    function DoCmd(id, cmdCol, cmdText) {
        $('.divCmds').html("clear | load");
        $('.divCmds' + cmdCol).empty();
        $('#divCmds' + cmdCol + '_' + id).html(cmdText).css('color', 'red');
    }
</script>