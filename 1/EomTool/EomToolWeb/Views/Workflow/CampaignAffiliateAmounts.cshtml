@model CampaignAffiliateAmountsModel
@{
    var campaignAmounts = Model.CampaignAmounts.OrderBy(ca => ca.CampaignName).ThenBy(ca => ca.AffiliateName).ToList();
    int lastPid = -1;
    bool grayRow = false;
    bool firstRow = true;
}

<table style="border: 1px solid gray">
    <tr>
        <th>PID</th>
        <th>Campaign</th>
        <th>Affiliate</th>
        <th>#Units</th>
        <th colspan="2">Revenue</th>
        <th>Invoiced</th>
        @if (Model.ShowCheckboxes)
        {
            <th colspan="2" style="text-align: left">&nbsp;Include</th>
        }
        <th colspan="2">Cost</th>
        <th>Margin</th>
    </tr>
@for (int i = 0; i < campaignAmounts.Count; i++)
{
    var ca = campaignAmounts[i];
    if (ca.Pid != lastPid)
    {
        lastPid = ca.Pid;
        grayRow = !grayRow;
        firstRow = true;
    }
    else
    {
        firstRow = false;
    }
    //decimal perunit = ca.Revenue / ca.NumUnits;
    <tr style="@(grayRow ? "background-color:#ddd" : "")">
        <td style="text-align: center">@(firstRow ? ca.Pid.ToString() : "")</td>
        <td>
            @if (firstRow)
            {
                @Html.ActionLink(ca.CampaignName, "EditCampaign", "Workflow", new { pid = ca.Pid }, new { target = "_blank", title = ca.CampaignDisplayName })
            }
        </td>
        <td>@ca.AffiliateName</td>
        <td style="text-align: center">@ca.NumUnits</td>
        <td>@ca.RevenueCurrency</td>
        <td style="text-align: right">@ca.Revenue.ToString("N2")</td>
        <td style="text-align: right">@ca.InvoicedAmount.ToString("N2")</td>
        @if (Model.ShowCheckboxes)
        {
            <td>
                @if ((ca.Revenue >= 0 && ca.InvoicedAmount < ca.Revenue) || (ca.Revenue < 0 && ca.InvoicedAmount != ca.Revenue))
                {
                    string checkedString = "checked=\"checked\"";
                    <input type="checkbox" name="idpairs" value="@(ca.Pid + "," + ca.AffId)" class="chk@(ca.Pid)" @checkedString />
                }
            </td>
            @* Note: We assume that each pid/affid pair has a unique currency *@
            <td>
                @if (firstRow)
                {
                    <text>&#x2713;:&nbsp;</text><a href="#" onclick="$('.chk@(ca.Pid)').prop('checked',true); return false">all</a>
                    <text>|&nbsp;</text><a href="#" onclick="$('.chk@(ca.Pid)').prop('checked',false); return false">none</a>
                }
            </td>
        }
        <td>@ca.CostCurrency</td>
        <td style="text-align: right">@ca.Cost.ToString("N2")</td>
        <td style="text-align: right; white-space: nowrap">@ca.MarginPct.ToString("P1")</td>
    </tr>
    if (i == campaignAmounts.Count - 1 || ca.Pid != campaignAmounts[i + 1].Pid)
    {
        //TOTAL row for a campaign...
        var sa = Model.SummaryAmount(ca.Pid);

        <tr style="@(grayRow ? "background-color:#ddd" : "")">
            <td></td>
            <td></td>
            <td style="font-weight: bold; text-align: right">CAMPAIGN TOTAL...</td>
            <td style="font-weight: bold; text-align: center">@sa.NumUnits</td>
            <td style="font-weight: bold">@sa.RevenueCurrency</td>
            <td style="font-weight: bold; text-align: right">@sa.Revenue.ToString("N2")</td>
            <td style="font-weight: bold; text-align: right">@sa.InvoicedAmount.ToString("N2")</td>
            @if (Model.ShowCheckboxes)
            {
                <td></td>
                <td></td>
            }
            <td style="font-weight: bold">@sa.CostCurrency</td>
            <td style="font-weight: bold; text-align: right">@sa.Cost.ToString("N2")</td>
            <td></td>
        </tr>
    }
}
</table>
